<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>lineChart</title>
  <script src="d3/d3.v3.js"></script>
  <style>
    .axis path,
    .axis line{
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 11px;
    }
    text {
      font-size: 12px;
    }
  </style>
</head>
<body>

</body>
<script>
const width  = 1250;
const height = 450;

const svg = d3.select("body")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

// 构造时间解析器
parseDate = d3.time.format("%Y/%m/%d").parse;
getMonth  = d3.time.format("%m");

/* d3.csv("USA_Superstore_Orders_2016_en-US_viz.csv", function(csv) { data = csv }) */
d3.csv("USA_Superstore_Orders_2016_en-US_viz.csv", function (data) {

    // 计算每一个类别对应的总营销额以及月份
    let arr = [];
    for (let i = 0; i < data.length; i++){
        let month = getMonth(parseDate(data[i].OrderDate));

        let hasSet = false;
        for (let j = 0; j < arr.length; j++) {
            if ( data[i].Category === arr[j][0] && month === arr[j][1] ) {
                arr[j][2] += Number(data[i].Sales);
                hasSet = true;
            }
        }
        if (!hasSet) {
            let newArr = [data[i].Category, month, Number(data[i].Sales)];
            arr.push(newArr);
        }
    }
    let Category = [], OrderMonth = [], Sales = [];
    for (let i of arr) {
        Category.push(i[0]);
        OrderMonth.push(i[1]);
        Sales.push(i[2]);
    }
    let OfficeSupplies = [], Technology = [], Furniture = [];
    for (let i of arr) {
        if (i[0] === "Office Supplies")
            OfficeSupplies.push(i);
        if (i[0] === "Technology")
            Technology.push(i);
        if (i[0] === "Furniture")
            Furniture.push(i);
    }
    OfficeSupplies.sort(function(x, y){
        return x[1] - y[1];
    });
    Technology.sort(function(x, y){
        return x[1] - y[1];
    });
    Furniture.sort(function(x, y){
        return x[1] - y[1];
    });

    // 给坐标轴预留出来空白
    const padding = {left:80, right:80, top:20, bottom:20};
    // 定义坐标轴的比例尺
    let xScale = d3.scale.linear()
        .domain(d3.extent(OrderMonth))
        .range([0, width - padding.left - padding.right]);
    let yScale = d3.scale.linear()
        .domain([0, d3.max(Sales)])
        .range([height - padding.top - padding.bottom, 0]);

    // 定义坐标轴
    const xAxis = d3.svg.axis().scale(xScale).orient('bottom');
    const yAxis = d3.svg.axis().scale(yScale).orient('left');

    // 添加坐标轴
    svg.append('g')
        .attr('class', 'axis')
        .attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
        .call(xAxis)
        // 增加坐标值说明
        .append('text')
        .text('月份')
        .attr('transform', "translate(" + (width - padding.left - padding.right) + ", -5)");
    svg.append('g')
        .attr('class', 'axis')
        .attr("transform","translate(" + padding.left + "," + padding.top + ")")
        .call(yAxis)
        .append('text')
        .text("销售量")
        .attr('transform', "translate(-34, -10)");

    //路径生成器
    let line = d3.svg.line()
        .x(function(d) { return xScale(d[1]) + padding.left; })
        .y(function(d) { return yScale(d[2]); })
        .interpolate("linear"); // monotone -> 平滑

    // 向svg添加线条
    let pathOfficeSupplies = svg.append('path')
        .data(arr)
        //.attr('class', 'line')
        .attr("fill", "transparent")
        .attr("stroke", "green")
        .attr('stroke-width', 2)
        .attr('d', line(OfficeSupplies));
    let pathTechnology = svg.append('path')
        .data(arr)
        //.attr('class', 'line')
        .attr("fill", "transparent")
        .attr("stroke", "red")
        .attr('stroke-width', 2)
        .attr('d', line(Technology));
    let pathFurniture = svg.append('path')
        .data(arr)
        //.attr('class', 'line')
        .attr("fill", "transparent")
        .attr("stroke", "blue")
        .attr('stroke-width', 2)
        .attr('d', line(Furniture));

    let circle = svg.selectAll('circle')
        .data(OfficeSupplies)
        .enter()
        .append('g')
        .append('circle')
        .attr('fill', 'green')
        .attr('cx', line.x())
        .attr('cy', line.y())
        .attr('r', 4)
        .on('mouseover', function(d) {
            d3.select(this).transition().duration(5).attr('r', 6);
        })
        .on('mouseout', function() {
            d3.select(this).transition().duration(5).attr('r', 4);
        });
});
</script>
</html>