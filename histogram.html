<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>histogram</title>
  <script src="d3/d3.v3.js"></script>
  <style>
    .axis path,
    .axis line{
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 11px;
    }
  </style>
</head>
<body>

</body>
<script>
const width  = 1250;
const height = 450;

const svg = d3.select("body")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

/* d3.csv("USA_Superstore_Orders_2016_en-US_viz.csv", function(csv) { data = csv }) */
d3.csv("USA_Superstore_Orders_2016_en-US_viz.csv", function (data) {

    // 计算每一个子类别对应的总营销额以及利润
    let arr = [];
    for (let i = 0; i < data.length; i++){
        let hasSubCategory = false;
        for (let j = 0; j < arr.length; j++) {
            if ( data[i].SubCategory === arr[j][0] ) {
                arr[j][1] += Number(data[i].Sales);
                arr[j][2] += + Number(data[i].Profit);
                hasSubCategory = true;
            }
        }
        if (!hasSubCategory) {
            let newArr = [data[i].SubCategory, Number(data[i].Sales), Number(data[i].Profit)];
            arr.push(newArr);
        }
    }
    let SubCategory = [], Sales = [], Profit = [];
    for (let i of arr) {
        SubCategory.push(i[0]);
        Sales.push(i[1]);
        Profit.push(i[2]);
    }

    // 给坐标轴预留出来空白
    const padding = {left:80, right:80, top:20, bottom:20};
    // 计算比例尺
    const xScale = d3.scale.ordinal()
        .domain(SubCategory)
        .rangeRoundBands( [0, width - padding.left - padding.right], 0.1 );
    const yScale = d3.scale.linear()
        .domain([ 0, parseInt(d3.max(Sales))+1 ])
        .range([ height - padding.top - padding.bottom, 0 ]);
    // 颜色比例尺
    const colorScale = d3.scale.linear()
        .domain([ parseInt(d3.min(Profit)), -0.1, 0, parseInt(d3.max(Profit))+1 ])
        .range(["#ffc107", "#ffe082", "#afbfff", "#455ede"]);

    //定义坐标轴
    const xAxis = d3.svg.axis().scale(xScale).orient("bottom");
    const yAxis = d3.svg.axis().scale(yScale).orient("left");

    //添加坐标轴
    svg.append("g")
        .attr("class","axis")
        .attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
        .call(xAxis);
    svg.append("g")
        .attr("class","axis")
        .attr("transform","translate(" + padding.left + "," + padding.top + ")")
        .call(yAxis);

    // 添加矩形元素
    svg.selectAll("rect")
        .data(arr)
        .enter()
        .append("rect")
        .attr("transform","translate(" + padding.left + "," + padding.top + ")")
        .attr("fill", function (d) {
            return colorScale(d[2]);
        })
        .attr("x", function(d){
            return xScale(d[0]);
        })
        .attr("y",function(d){
            return yScale(d[1]);
        })
        .attr("width", xScale.rangeBand())
        .attr("height", function(d){
            return height - padding.top - padding.bottom - yScale(d[1]);
        })
        // 添加鼠标事件
        .on("mouseover", function(d) { //鼠标悬停添加文字
            //取得鼠标所在元素的坐标
            const location = this.getBoundingClientRect();
            //console.log(location);

            //控制文字显示位置
            const x = location.left - 5;
            // 高于一半则显示在下方，否则显示在上方
            const y = (yScale(d[1]) > height/2)
                ? height - location.height - 64
                : height - location.height;

            //选择悬停元素的父元素，并向里面添加text标签和州的名字
            d3.select(this.parentNode)
                .append('text')
                .attr("id", "SubCategory").attr("x", x).attr("y", y)
                .text(function() { return "子类别：" + d[0]; });
            //第二行数据，显示销售量，y相对上一行多了20px
            d3.select(this.parentNode)
                .append('text')
                .attr("id", "Sales").attr("x", x).attr("y", y+20)
                .text(function() { return "销售量：" + parseInt(d[1]); });
            //第三行数据，显示利润，y相对上一行多了40px
            d3.select(this.parentNode)
                .append('text')
                .attr("id", "Profit").attr("x", x).attr("y", y+40)
                .text(function() { return "利润：" + parseInt(d[2]); });
        })
        .on("mouseout", function() { //鼠标移开删除文字
            //删除提示条
            d3.select("#SubCategory").remove();
            d3.select("#Sales").remove();
            d3.select("#Profit").remove();
        });
});

</script>
</html>
